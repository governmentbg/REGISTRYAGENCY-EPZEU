import { ObjectHelper } from 'Cnsys.Core';
import { EPZEUBaseValidator } from 'EPZEU.Core';
import { DomainModelHepler, IApplicationFormValidationContext, PersonBaseValidator, RecordOperations, RecordValidator, SimpleAddressValidator, ValidatorHelpers } from 'EPZEU.CR.Domain';
import { F53710_OffshoreDirectControlCompanyRepresentative, F5371_OffshoreDirectControlCompanyRepresentatives } from '../ModelsAutoGenerated';

export class F5371_OffshoreDirectControlCompanyRepresentativesValidator extends EPZEUBaseValidator<F5371_OffshoreDirectControlCompanyRepresentatives, IApplicationFormValidationContext> {
    constructor() {
        super();

        this.ruleFor(m => m.offshoreDirectControlCompanyRepresentativesList).setCollectionValidator(new F53710_OffshoreDirectControlCompanyRepresentativeValidator());
    }

    public validate(obj: F5371_OffshoreDirectControlCompanyRepresentatives): boolean {
        let isValid = super.validate(obj);

        if (obj.offshoreDirectControlCompanyRepresentativesList.length > 1) {
            for (var i = 0; i < obj.offshoreDirectControlCompanyRepresentativesList.length; i++) {
                //Искаме да се показват валидации само когато записът е променен. В останалте случаи се зачистват
                if (obj.offshoreDirectControlCompanyRepresentativesList[i].recordOperation != RecordOperations.Add) {
                    obj.offshoreDirectControlCompanyRepresentativesList[i].clearErrors(true);
                }

                if (this.validationContext.isRecordEmpty(obj.offshoreDirectControlCompanyRepresentativesList[i]) && obj.offshoreDirectControlCompanyRepresentativesList[i].recordOperation != RecordOperations.Erase) {
                    // Искаме когато се показва съобщение "Попълнете данните за полето или го изтрийте" да не се показват други съобщеения.
                    obj.offshoreDirectControlCompanyRepresentativesList[i].clearErrors(true);
                    obj.offshoreDirectControlCompanyRepresentativesList[i].addError(this.getMessage('CR_APP_00063_E'));// Попълнете данните за полето или го изтрийте.

                    isValid = false;
                }
            }

            //Грешката се визуалзира при добавяне на второ и следващо лице със същия идентификатор като на вече добавено лице
            if (ValidatorHelpers.isExistDublicateIndents(obj.offshoreDirectControlCompanyRepresentativesList, true, "CR_APP_00112_E")) //  Има друг представител със същия идентификатор (ЕГН/ЛНЧ).
                isValid = false;
        }

        return isValid;
    }
}

export class F53710_OffshoreDirectControlCompanyRepresentativeValidator extends RecordValidator<F53710_OffshoreDirectControlCompanyRepresentative> {
    constructor() {
        super();

        this.ruleFor(m => m.person).setValidator(new PersonBaseValidator());
    }

    public validateInternal(obj: F53710_OffshoreDirectControlCompanyRepresentative): boolean {

        let isValid = super.validateInternal(obj);

        if (!DomainModelHepler.isObjectEmpty(obj)) {

            if (ObjectHelper.isStringNullOrEmpty(obj.person.name)
                && ObjectHelper.isStringNullOrEmpty(obj.person.indent)) {
                obj.addError(this.getMessage('GL_INPUT_NAME_ID_E'));
                isValid = false;
            }

            if (isValid && !DomainModelHepler.isObjectEmpty(obj.person)) {

                //Грешката се визуализира когато няма избрана държава
                if (ObjectHelper.isNullOrUndefined(obj.person.countryID)) {
                    obj.person.addError('countryName', this.getMessage('CR_APP_00031_E'));
                    isValid = false;
                }
                else {
                    //Грешката се визуализира при избрана държава различна от България и в полето за идентификация е попълнено валиден идентификатор (ЕГН). 
                    if (ValidatorHelpers.isCountryBGRequired(obj.person.countryID, obj.person.indentType, null, true)) {
                        obj.person.addError('countryName', this.getMessage('CR_APP_00047_E'));
                        isValid = false;
                    }
                }
            }

            let isValidAddress = new SimpleAddressValidator();
            isValidAddress.setValidationContext(this.getValidationContext());

            if (isValid && !DomainModelHepler.isObjectEmpty(obj.address)) {

                if (!isValidAddress.validate(obj.address))
                    isValid = false;
            }

            if (isValid && !DomainModelHepler.isObjectEmpty(obj.countryOfResidence)) {

                if (!isValidAddress.validate(obj.countryOfResidence))
                    isValid = false;
            }
        }

        return isValid;
    }
}