import { ObjectHelper } from 'Cnsys.Core';
import { DomainModelHepler, RecordValidator, SubjectFLEBaseValidator, ValidatorHelpers, ProcessStates, RecordOperations } from 'EPZEU.CR.Domain';
import { F0240_ShareTransfer } from '../ModelsAutoGenerated';

export class F0240_ShareTransferValidator extends RecordValidator<F0240_ShareTransfer> {
    constructor() {
        super();
        
        this.ruleFor(m => m.oldOwner).setValidator(new SubjectFLEBaseValidator());
        this.ruleFor(m => m.newOwner).setValidator(new SubjectFLEBaseValidator());
        this.ruleFor(m => m.transferDate).must(m => ValidatorHelpers.isValidDate(m.transferDate)).withMessage(this.getMessage('GL_INPUT_DATE_E')).when(m => !ObjectHelper.isStringNullOrEmpty(m.transferDate));
        this.ruleFor(m => m.shareAmount).matches('^\\s*\\d+(\\d)*\\s*$').withMessage(this.getMessage('GL_INPUT_INTEGER_E'));
    }

    public validateInternal(obj: F0240_ShareTransfer): boolean {
        
        let isValid = super.validateInternal(obj);

        let valCtx = this.getValidationContext();
        if (valCtx.processStates == ProcessStates.ForChange
            && (obj.recordOperation == RecordOperations.Current || obj.recordOperation == RecordOperations.Erase)) {
            obj.clearErrors(true);
            return true;
        }    

        if ((!DomainModelHepler.isObjectEmpty(obj.oldOwner) && (obj.oldOwnerCountryID == null || ObjectHelper.isStringNullOrEmpty(obj.oldOwnerCountryName)))) {
            obj.addError('oldOwnerCountryName', this.getMessage('CR_APP_00031_E')); //Изберете държава. 
            isValid = false;
        }
        else {
            let idType = DomainModelHepler.getIdentType(obj.oldOwner.indent);                     
            //ако лицето не е отбелязано, че е чуждестранно и е попълнен идентификатор, който е различен от дата на раждане, държавата трябва да е БГ
            if (ValidatorHelpers.isCountryBGRequired(obj.oldOwnerCountryID, idType, obj.oldOwner.isForeignTrader, false)) {
                obj.addError('oldOwnerCountryName', this.getMessage('CR_APP_00047_E'));//Изберете държава "България"! 
                isValid = false;
            }
        }

        if ((!DomainModelHepler.isObjectEmpty(obj.newOwner) && (obj.newOwnerCountryID == null || ObjectHelper.isStringNullOrEmpty(obj.newOwnerCountryName)))) {
            obj.addError('newOwnerCountryName', this.getMessage('CR_APP_00031_E'));//Изберете държава. 
            isValid = false;
        }
        else {
            let idType = DomainModelHepler.getIdentType(obj.newOwner.indent);                       
            //ако лицето не е отбелязано, че е чуждестранно и е попълнен идентификатор, който е различен от дата на раждане, държавата трябва да е БГ
            if (ValidatorHelpers.isCountryBGRequired(obj.newOwnerCountryID, idType, obj.newOwner.isForeignTrader, false)) {
                obj.addError('newOwnerCountryName', this.getMessage('CR_APP_00047_E'));//Изберете държава "България"! 
                isValid = false;
            }
        }

        return isValid;
    }
}