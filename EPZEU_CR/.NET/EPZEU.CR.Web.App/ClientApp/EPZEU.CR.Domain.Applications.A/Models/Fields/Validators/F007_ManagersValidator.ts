import { ArrayHelper } from 'Cnsys.Core';
import { EPZEUBaseValidator } from 'EPZEU.Core';
import { IApplicationFormValidationContext, RecordOperations, ValidatorHelpers } from 'EPZEU.CR.Domain';
import { F007_Managers } from '../ModelsAutoGenerated';
import { F0070_ManagerValidator } from './F0070_ManagerValidator';

export class F007_ManagersValidator extends EPZEUBaseValidator<F007_Managers, IApplicationFormValidationContext> {
    constructor() {
        super();

        this.ruleFor(m => m.managersList).setCollectionValidator(new F0070_ManagerValidator());
    }

    public validate(obj: F007_Managers): boolean {
        let isValid = super.validate(obj);
        let valCtx = this.getValidationContext();

        if (ValidatorHelpers.hasMandatoryRecordsForChange(valCtx.processStates, obj.managersList, true)) {

            let cntNotEmptyManagers: number = ArrayHelper.queryable.from(obj.managersList).where(m => m.recordOperation != RecordOperations.Erase && !ValidatorHelpers.isObjectWithPersonEmpty(m, "person")).count();

            if (cntNotEmptyManagers == 0) {
                //Грешката трябва да се визуализира когато не е попълнен поне един управител 
                obj.clearErrors();
                obj.addError(this.getMessage('CR_APP_00003_E'));

                isValid = false;
            }
        }

        //При добавяне на второ и следващо лице трябва да се извършва проверкта дали идентификатора на добавеното лице със същия идентификатор като на вече добавено лице.
        //Валидацията не се прилага за идентификатор Дата на раждане 
        if (obj.managersList.length > 1) {

            for (var i = 0; i < obj.managersList.length; i++) {
                if (ValidatorHelpers.isObjectWithPersonEmpty(obj.managersList[i], "person") && obj.managersList[i].recordOperation != RecordOperations.Erase) {
                    obj.managersList[i].clearErrors(true);
                    obj.managersList[i].addError(this.getMessage('CR_APP_00063_E'));// Попълнете данните за полето или го изтрийте.

                    isValid = false;
                }
            }

            if (ValidatorHelpers.isExistDublicateIndents(obj.managersList, true, "CR_APP_00062_E"))
                isValid = false;
        }

        return isValid;
    }
}