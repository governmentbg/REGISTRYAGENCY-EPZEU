import { Branch, IApplicationWithFieldsFormManager, PersonTypes } from 'EPZEU.CR.Domain';
import { observable } from 'mobx';
import { V32 } from '../Models/ApplicationForms/ApplicationFormsV';
import { F8030_Successor803 } from '../Models/Fields/ModelsAutoGenerated';
import { IF803Manager } from '../UI/Fields/F803_SuccessorsUI';
import { ApplicationFormVBaseManager } from './ApplicationFormVBaseManager';

export interface IV32FormManager extends IApplicationWithFieldsFormManager {
    reorganizeCoOperativeBranches: Branch[];
    successors: F8030_Successor803[];
}

export class V32FormManager extends ApplicationFormVBaseManager<V32> implements IV32FormManager, IF803Manager {

    constructor() {
        super();

        this.onUICChange = this.onUICChange.bind(this);
        this.searchBranchesByUIC = this.searchBranchesByUIC.bind(this);
    }

    protected createApplication(obj: any): V32 {
        return new V32(obj);
    }

    /**Инициализира данните на заявленеито*/
    protected initApplicationData(): Promise<void> {
        let that = this;

        return super.initApplicationData().bind(this).then(() => {
            return super.searchBranchesByUIC(that.application.fields.reorganizeCoOperatives.coOperativeList[0].subject.indent).then((branches) => {
                that.reorganizeCoOperativeBranches = branches;
            });
        });
    }

    public get successors(): F8030_Successor803[] {
        return this.application.fields.successors803.successorList;
    }

    public onUICChange(uic: string): Promise<void> {
        let that = this;

        return super.onUICChange(uic).then(() => {
            return super.searchBranchesByUIC(that.application.fields.reorganizeCoOperatives.coOperativeList[0].subject.indent).then((branches) => {
                that.reorganizeCoOperativeBranches = branches;
            });
        })
    }

    // поле 804 показва в dropdown клоновете на избраната фирма в поле 802.
    @observable public reorganizeCoOperativeBranches: Branch[] = []

    get personTypeForField803(): PersonTypes {
        return PersonTypes.Successor803V32;
    }
}