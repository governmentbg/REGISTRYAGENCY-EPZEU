import { ErrorLevels } from 'Cnsys.Core';
import { ApplicantExchangeValidator, ApplicationFormBaseValidator, IApplicationFormValidationContext, ApplicantInfoValidator } from 'EPZEU.CR.Domain';
import { ActOfContestation } from '../ModelsAutoGenerated';
import { ContestationActValidator } from './ContestationActValidator';

export class ActOfContestationValidator extends ApplicationFormBaseValidator<ActOfContestation> {

    possibleActAttachedDocuments: any = null;

    constructor() {
        super();

        this.ruleFor(m => m.applicantInfo).setValidator(new ApplicantInfoValidator());
        this.ruleFor(m => m.applicantExchange).setValidator(new ApplicantExchangeValidator());
        this.ruleFor(m => m.contestationAct).setValidator(new ContestationActValidator());
    }

    setValidationContext(validationContext: IApplicationFormValidationContext): void {
        super.setValidationContext(validationContext);

        this.getValidationContext().applicationManager.getPossibleAttachedDocumentTypes()
            .bind(this).then(s => {
                this.possibleActAttachedDocuments = s.filter(s => s.minOccurs == 1 && s.maxOccurs == 1);
            })
    }

    public validate(obj: ActOfContestation): boolean {
        let isValid = super.validate(obj);
        let that = this;

        if (obj.documents == null || obj.documents.length == 0) {
            obj.addError('documents', that.getMessage('GL_NOATTACHED_DOCUMENTS_E')); // Няма приложени документи.

            isValid = false;
        }

        else {

            if (this.possibleActAttachedDocuments != null) {
                this.possibleActAttachedDocuments.forEach(function (possibleDoc: any) {

                    let possibleActDocCount: number = obj.documents.filter(d => d.documentTypeID == possibleDoc.documentTypeID).length;

                    if (possibleActDocCount < possibleDoc.minOccurs || possibleActDocCount > possibleDoc.maxOccurs) {
                        obj.addError('documents', that.getMessage('GL_NOATTACHED_DOCUMENTS_E')); // Няма приложени документи.

                        isValid = false;
                    }
                });
            }
        }

        obj.setAllErrorsLevel(ErrorLevels.Error);

        return isValid;
    }
}