import { EPZEUBaseValidator } from "EPZEU.Core";
import { IApplicationFormValidationContext } from "EPZEU.CR.Domain";
import { IncomingNumber } from "../ModelsAutoGenerated";
import { ApplicationsService } from "EPZEU.CR.Core";
import { ObjectHelper } from "Cnsys.Core";

export class IncomingNumberValidator extends EPZEUBaseValidator<IncomingNumber, IApplicationFormValidationContext> {

    constructor() {
        super();

        this.ruleFor(m => m.incomingNo).notEmpty().withMessage(this.getMessage('GL_INPUT_APPLICATION_NO_E')); //Попълнете номер на заявление
    }

    public validate(obj: IncomingNumber): boolean {
        let isValid = super.validate(obj);

        let applicationService = this.validationContext.dataServiceProvider.getDataService<ApplicationsService>(ApplicationsService);

        if (!ObjectHelper.isStringNullOrEmpty(obj.incomingNo)) {
            applicationService.getApplicationInfoByIncommingNumber(obj.incomingNo).then((appInfo) => {

                obj.removeError('incomingNo');
                if (!appInfo) {
                    obj.addError('incomingNo', this.getMessage('GL_INPUT_INCOMING_NO_E'));
                    return false;
                }
            })
        }

        return isValid;
    }
}